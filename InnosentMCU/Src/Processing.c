/**************************************************************************************

      II    N     N     N     N      OOOO      SSSSS     EEEEE    N     N    TTTTTTT
     II    NNN   N     NNN   N    OO    OO    S         E        NNN   N       T
    II    N NN  N     N NN  N    OO    OO    SSSSS     EEE      N NN  N       T
   II    N  NN N     N  NN N    OO    OO        S     E        N  NN N       T
  II    N    NN     N    NN      OOOO      SSSSS     EEEEE    N    NN       T
                         copyright (c) 2016, InnoSenT GmbH
                                 all rights reserved

***************************************************************************************

	filename:		Processing.c
	brief:			Signal Processing
	creation:		19.01.2017
	author:			Sergej Gauerhof
	last editor:	.....


**************************************************************************************/

/**************************************************************************************
   preprocessor includes
**************************************************************************************/
#include "Processing.h"
#include "CONFIG.h"
#include "Initialization.h"
#include "arm_math.h"
#include "arm_const_structs.h"
/**************************************************************************************
   preprocessor defines
**************************************************************************************/

/**************************************************************************************
   global constants
**************************************************************************************/

/**************************************************************************************
   global variables
**************************************************************************************/
/* Hann window function */
float32_t windowingFunc[FFT_SIZE] = {0,0.00061179,0.0024457,0.0054971,0.0097588,0.01522,0.021868,0.029685,0.038654,0.048752,0.059954,0.072232,0.085558,0.099898,0.11522,0.13148,0.14864,0.16666,0.1855,0.20511,0.22544,0.24644,0.26806,0.29025,0.31295,0.33611,0.35967,0.38358,0.40777,0.43218,0.45676,0.48145,0.50618,0.5309,0.55554,0.58005,0.60436,0.62841,0.65215,0.67552,0.69846,0.72091,0.74283,0.76414,0.78481,0.80479,0.82402,0.84245,0.86005,0.87677,0.89256,0.9074,0.92123,0.93404,0.94578,0.95644,0.96597,0.97437,0.9816,0.98766,0.99252,0.99618,0.99862,0.99985,0.99985,0.99862,0.99618,0.99252,0.98766,0.9816,0.97437,0.96597,0.95644,0.94578,0.93404,0.92123,0.9074,0.89256,0.87677,0.86005,0.84245,0.82402,0.80479,0.78481,0.76414,0.74283,0.72091,0.69846,0.67552,0.65215,0.62841,0.60436,0.58005,0.55554,0.5309,0.50618,0.48145,0.45676,0.43218,0.40777,0.38358,0.35967,0.33611,0.31295,0.29025,0.26806,0.24644,0.22544,0.20511,0.1855,0.16666,0.14864,0.13148,0.11522,0.099898,0.085558,0.072232,0.059954,0.048752,0.038654,0.029685,0.021868,0.01522,0.0097588,0.0054971,0.0024457,0.00061179,0};
/**************************************************************************************
   global function prototypes
**************************************************************************************/

/**************************************************************************************
   local constants
**************************************************************************************/

/**************************************************************************************
   local macros
**************************************************************************************/

/**************************************************************************************
   local types
**************************************************************************************/

/**************************************************************************************
   local variables
**************************************************************************************/

/**************************************************************************************
   local function prototypes
**************************************************************************************/

/**************************************************************************************
   local function definitions
**************************************************************************************/

/**************************************************************************************
	function name:		g_SignalProcessing
	purpose:			signal processing

	return value:		none
	input parameters:	none
	output parameters:	none

	creation:			19.01.2017
	author:				Sergej Gauerhof
	version:			V1.0
	last edit:			13.02.2017
	last editor:		Duy Bien Le
	change:				...

**************************************************************************************/
void g_SignalProcessing(void)
{
	int16_t i16_meanI, i16_meanQ;
	float32_t fftMagTemp;

	/* Calculate mean values of I and Q */
	i16_meanI = g_i16_calculate_mean(I, FFT_SIZE);
	i16_meanQ = g_i16_calculate_mean(Q, FFT_SIZE);

	/* Preserve raw signal */
	for (uint16_t i=0; i<FFT_SIZE; i++)
	{
		rawI[i] = I[i];
		rawQ[i] = Q[i];
	}

	/* Remove DC offsets */
	for(uint16_t i=0; i<FFT_SIZE; i++)
	{
		I[i] = (I[i] - i16_meanI);
		Q[i] = (Q[i] - i16_meanQ);
	}

	/* Check and limit signals to +-2047 (12-bits)  */
	for(uint16_t i=0; i<FFT_SIZE; i++)
	{
		if(I[i] >= 2047)
		{
			I[i] = 2047;
		}

		if(I[i] <= -2047)
		{
			I[i] = -2047;
		}

		if(Q[i] >= 2047)
		{
			Q[i] = 2047;
		}

		if(Q[i] <= -2047)
		{
			Q[i] = -2047;
		}
	}

	/* Apply windowing and assign I/Q to suitable format for FFT-process (I-Q interleave) */
	for(uint16_t i=0; i<FFT_SIZE; i++)
	{
		IQ[2*i] = (float32_t)(I[i]*windowingFunc[i]);
		IQ[2*i+1] = (float32_t)(Q[i]*windowingFunc[i]);
	}

	/* perform FFT process */
	arm_cfft_f32(&arm_cfft_sR_f32_len128, IQ, 0, 1);

	/* FFT normalization */
	for(uint16_t i=0; i<2*FFT_SIZE; i++)
	{
		IQ[i] = IQ[i]/(FFT_SIZE);
	}

	/* Calculate fft magnitude in 20*log10(abs(fft)) scale */
	for(uint16_t i=0; i<FFT_SIZE; i++)
	{
		fftMagTemp = (IQ[2*i]*IQ[2*i] + IQ[2*i+1]*IQ[2*i+1]);
		fftMagTemp = 10*log10f(fftMagTemp);
		FFTmagnitude[i] = (int32_t)(fftMagTemp);
	}
}

/**************************************************************************************
	function name:		g_i16_calculate_mean
	purpose:			calculate mean value of a data vector

	return value:		mean value
	input parameters:	data vector
	output parameters:	none

	author:				Duy Bien Le
	creation:			06.12.2016
**************************************************************************************/
int16_t g_i16_calculate_mean(int16_t *signal, uint16_t length)
{
	int32_t i32_sum = 0;
	for(uint16_t i=0; i<length; i++)
	{
		i32_sum = i32_sum + signal[i];
	}

	return (int16_t)(i32_sum/length);
}




